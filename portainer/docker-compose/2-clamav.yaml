version: "3.9"

services:
  clamav:
    image: clamav/clamav:stable_base
    container_name: clamav
    tty: True
    environment:
      PGID: '568'
      PUID: '568'
      TZ: 'Australia/Melbourne'
    volumes:
      # - bind:
      #     create_host_path: False
      #     propagation: rprivate
      #   read_only: False
      #   source: /mnt/apps-pool/apps/clamav/config
      #   target: /etc/clamav
      #   type: bind
      - bind:
          create_host_path: False
          propagation: rprivate
        read_only: False
        source: /mnt/apps-pool/apps/clamav/data
        target: /var/lib/clamav
        type: bind
      - bind:
          create_host_path: False
          propagation: rprivate
        read_only: False
        source: /mnt/tank/media
        target: /media
        type: bind
    command: >
      sh -c "
        apk add inotify-tools &&
        freshclam &&
        echo 'Monitoring /media/downloads/complete/ for new files...' &&
        inotifywait -mrq -e close_write,create,moved_to --format '%w%f' /media/downloads/complete/ |
        while read file; do
          echo 'Scanning:' \"$file\" &&
          if clamscan \"$file\" --move=/media/quarantine/ | grep -q 'Infected files: 0'; then
            mv \"$file\" /media/scanned/;
          fi;
        done
      "
    healthcheck:
      test: ["CMD-SHELL", "freshclam --version || exit 1"]
      interval: 300s
      timeout: 15s
      retries: 3
    restart: unless-stopped